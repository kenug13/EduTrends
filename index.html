<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrends v.1 - Pixar Style Storyboarder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #0B1120; /* Deep Navy Blue */
            background-image: radial-gradient(rgba(34, 211, 238, 0.1) 1px, transparent 1px), radial-gradient(rgba(34, 211, 238, 0.1) 1px, #0B1120 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            color: #e5e7eb;
        }
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        .btn { transition: all 0.2s ease-in-out; }
        .btn:active:not(:disabled) { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(45deg, #22D3EE, #0891B2); color: white; box-shadow: 0 4px 15px rgba(34, 211, 238, 0.2); }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(45deg, #0891B2, #0e7490); box-shadow: 0 6px 20px rgba(34, 211, 238, 0.3); }
        .btn-success { background-color: #16A34A; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803D; }
        .btn-secondary { background-color: #374151; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4B5563; }
        .btn-ai { background: linear-gradient(45deg, #0891B2, #0d9488); color: white; }
        .btn-ai:hover:not(:disabled) { background: linear-gradient(45deg, #06b6d4, #0f766e); }
        .btn-prompt-canva { background-color: #0891b2; color: white; }
        .btn-prompt-canva:hover:not(:disabled) { background-color: #0e7490; }
        .btn-copy { background-color: #4B5563; color: #D1D5DB; }
        .btn-copy:hover:not(:disabled) { background-color: #6B7280; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .loader, .inline-loader {
            border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #22D3EE;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        .inline-loader {
            width: 20px; height: 20px; border-width: 2px;
            border-top-color: white; border-left-color: white; border-right-color: white; border-bottom-color: transparent;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn { border-bottom: 2px solid transparent; color: #9ca3af; transition: all 0.2s; }
        .tab-btn:hover { color: #d1d5db; }
        .tab-btn.active { border-bottom-color: #22D3EE; color: #22D3EE; }
        
        .prompt-output { 
            font-family: 'Roboto Mono', monospace;
            background-color: #111827; 
            border: 1px solid #374151; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e5e7eb;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .idea-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .idea-card:hover { border-color: #0891B2; transform: translateY(-2px); }
        .idea-card.selected { border-color: #22D3EE; background-color: #374151; box-shadow: 0 0 15px rgba(34, 211, 238, 0.3); }
        
        .custom-modal-overlay {
            position: fixed; inset: 0; background-color: rgba(10, 10, 10, 0.9);
            display: none; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
            backdrop-filter: blur(4px);
        }
        .custom-modal-overlay.visible { display: flex; opacity: 1; pointer-events: auto; }
        
        .custom-modal-content {
            background-color: #1f2937; border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 2rem; max-width: 90%; width: 600px;
            border: 1px solid #374151;
            transform: scale(0.95); transition: transform 0.3s ease-in-out;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .custom-modal-overlay.visible .custom-modal-content { transform: scale(1); }
        
        .action-dna-tag { cursor: pointer; transition: all 0.2s ease; }
        .action-dna-tag.selected { background-color: #0891B2; color: white; border-color: #0e7490; }
        
        .glass-card {
            background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px);
            border-radius: 1rem; border: 1px solid rgba(55, 65, 81, 0.5);
        }
        
        .suggestion-list { list-style: none; padding-left: 0; }
        .suggestion-list li { display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.25rem; }
        .suggestion-list li svg { flex-shrink: 0; margin-top: 4px; color: #22d3ee; }
        
        .futuristic-text-glow { text-shadow: 0 0 10px rgba(34, 211, 238, 0.4); }
    </style>
</head>
<body class="antialiased selection:bg-cyan-500 selection:text-white">

    <!-- Password Overlay -->
    <div id="password-overlay" class="fixed inset-0 bg-gray-950/95 backdrop-blur-md flex items-center justify-center z-50">
        <div class="glass-card p-8 rounded-2xl shadow-2xl text-center w-full max-w-sm fade-in border-cyan-900/50">
            <div class="h-24 w-24 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 mx-auto mb-6 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <span class="text-3xl font-bold text-white">EC</span>
            </div>
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-sky-400 mb-2 futuristic-text-glow">Akses Terbatas</h2>
            <p class="text-gray-400 mb-6 text-sm">Silakan masukkan kata sandi untuk melanjutkan.</p>
            <form id="password-form" class="space-y-4">
                <div class="relative">
                    <input type="password" id="password-input" placeholder="Kata Sandi" class="w-full text-center bg-gray-800 border border-gray-700 rounded-lg p-3 pr-10 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all text-white placeholder-gray-500">
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-cyan-400">
                        <svg id="eye-icon-password" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                        <svg id="eye-slash-icon-password" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye-slash-fill hidden" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>
                    </button>
                </div>
                <button type="submit" class="btn btn-primary font-bold py-3 px-6 rounded-lg w-full">Masuk</button>
            </form>
            <p class="text-xs text-gray-500 mt-4">Hint: <code>SUKSES2025</code></p>
            <p id="password-error" class="text-red-400 text-sm mt-2 hidden bg-red-900/20 py-1 rounded">Kata sandi salah. Coba lagi.</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-wrapper" class="fade-in" style="display: none;">
        <header class="text-center py-4 px-4 md:px-8 sticky top-0 z-30 pointer-events-none">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center glass-card p-3 pointer-events-auto shadow-lg shadow-cyan-900/10">
                <div class="flex items-center gap-3 mb-3 md:mb-0">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-xs">EC</div>
                    <h1 class="text-xl md:text-2xl font-extrabold tracking-tight">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-sky-400 futuristic-text-glow">EduTrends v.1</span>
                    </h1>
                </div>
                <div class="flex items-center gap-2 md:gap-3 flex-wrap justify-center">
                    <button id="importProjectBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Impor
                    </button>
                    <button id="exportProjectBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg> Ekspor
                    </button>
                    <button id="resetProjectBtn" class="btn btn-primary font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg> BARU
                    </button>
                    <button id="openSettingsBtn" class="btn btn-secondary p-2 rounded-lg" title="Pengaturan API">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1 0 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105 0l.17.31c.698 1.283 2.686.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 0-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105 0l-.17-.31zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row max-w-7xl mx-auto gap-6 p-4 md:p-6">
            
            <!-- Sidebar -->
            <aside class="w-full lg:w-1/3 xl:w-1/4 space-y-6 flex-shrink-0">
                
                <div id="characterSection" class="glass-card overflow-hidden">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-cyan-400" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                            Tokoh Cerita 3D
                        </h2>
                    </div>
                    <div class="p-4 space-y-4">
                        <p class="text-xs text-gray-400">Buat 'aktor' 3D yang ekspresif. Semua tokoh otomatis bergaya 3D Disney Pixar.</p>
                        <button id="openAddCharModalBtn" class="btn btn-ai font-semibold py-2 px-4 rounded-lg w-full flex items-center justify-center gap-2 text-sm shadow-lg shadow-cyan-900/20">
                            <span>+</span> Buat Tokoh Baru
                        </button>
                        
                        <div class="pt-4 mt-4 border-t border-gray-700/50">
                            <h3 class="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wider">Tokoh Siap Pakai</h3>
                            <div id="templateCharList" class="space-y-2"></div>
                        </div>

                        <div class="pt-4 mt-4 border-t border-gray-700/50">
                             <h3 class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Tokoh Anda:</h3>
                             <div id="charListContainer" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                        </div>
                    </div>
                </div>

                <div id="directingSection" class="glass-card overflow-hidden">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-cyan-400" viewBox="0 0 16 16"><path d="M6 3a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM1 13.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5zM2 6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2H2V6z"/></svg>
                            Arahan Cerita
                        </h2>
                    </div>
                    <div class="p-4 space-y-4">
                         <div class="p-3 bg-cyan-950/40 border border-cyan-800/50 rounded-lg text-center">
                            <p class="font-bold text-cyan-300 text-sm">Gaya Visual Terkunci ðŸŽ¨</p>
                            <p class="text-[10px] text-cyan-400/80 mt-1">Gaya 3D Disney Pixar diterapkan otomatis.</p>
                        </div>
                        
                        <div>
                            <label for="locationSet" class="block text-xs font-semibold text-gray-400 mb-1">Latar Tempat:</label>
                            <select id="locationSet" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                                <option value="ruang_kelas">Ruang Kelas Modern</option>
                                <option value="laboratorium">Laboratorium</option>
                                <option value="perpustakaan">Perpustakaan</option>
                                <option value="alam_terbuka">Alam Terbuka (Studi Lapangan)</option>
                                <option value="latar_sejarah">Latar Sejarah / Museum</option>
                                <option value="studio_minimalis">Studio Minimalis</option>
                                <option value="dunia_mimpi">Dunia Penuh Mimpi</option>
                                <option value="taman_permen">Taman Permen</option>
                                <option value="custom_location">Custom Latar...</option>
                            </select>
                            <input type="text" id="customLocationInput" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm mt-2 hidden" placeholder="e.g. Dalam Tubuh Manusia">
                        </div>
                        <div>
                            <label for="cameraStyleSet" class="block text-xs font-semibold text-gray-400 mb-1">Sudut Pandang Kamera:</label>
                            <select id="cameraStyleSet" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                                <option value="standard_cinematic">Sinematik Standar</option>
                                <option value="fpv_drone_dive">Drone FPV</option>
                                <option value="ground_level_action_cam">Kamera Aksi (Level Objek)</option>
                                <option value="satellite_zoom">Zoom Satelit</option>
                                <option value="dolly_zoom_vertigo">Dolly Zoom (Efek Vertigo)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label for="narratorLanguageSet" class="block text-xs font-semibold text-gray-400 mb-1">Bahasa:</label>
                                <select id="narratorLanguageSet" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                                    <option value="no_narrator">Tanpa Narator</option>
                                    <option value="Indonesian">Bahasa Indonesia</option>
                                    <option value="English">English</option>
                                    <option value="Javanese">Bahasa Jawa</option>
                                    <option value="Sundanese">Bahasa Sunda</option>
                                    <option value="custom_language">Lainnya...</option>
                                </select>
                                <input type="text" id="customNarratorLanguageInput" class="w-full bg-gray-800 border border-cyan-500/50 rounded-lg p-2 text-sm mt-2 hidden" placeholder="e.g. Batak">
                            </div>
                            <div>
                                <label for="narratorVoiceSet" class="block text-xs font-semibold text-gray-400 mb-1">Gaya Suara:</label>
                                <select id="narratorVoiceSet" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                                    <option value="dialog_murni">Hanya Dialog (Tanpa Narator)</option>
                                    <option value="pria_dewasa_ramah">Pria Dewasa (Ramah)</option>
                                    <option value="wanita_dewasa_lembut">Wanita Dewasa (Lembut)</option>
                                    <option value="anak_laki_laki_ceria">Anak Laki-laki (Ceria)</option>
                                    <option value="anak_perempuan_semangat">Anak Perempuan (Semangat)</option>
                                    <option value="narator_dokumenter_berwibawa">Dokumenter (Wibawa)</option>
                                    <option value="suara_robot_informatif">Robot (Informatif)</option>
                                </select>
                            </div>
                        </div>
                        <div id="narratorStyleLock" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-center mt-2">
                             <p id="selectedNarratorStyleText" class="text-xs text-gray-400 italic">Pria Dewasa (Ramah)</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="w-full lg:w-2/3 xl:w-3/4 glass-card min-h-[600px] flex flex-col">
                <div id="tabsContainer" class="border-b border-gray-700 flex px-2 bg-gray-800/30 rounded-t-xl">
                    <button id="tabNaskah" class="tab-btn active font-semibold py-4 px-6 text-sm focus:outline-none">1. Naskah Cerita</button>
                    <button id="tabStoryboard" class="tab-btn font-semibold py-4 px-6 text-sm focus:outline-none">2. Papan Cerita (Storyboard)</button>
                </div>

                <div id="naskahView" class="p-6 space-y-6 flex-grow">
                    <div>
                        <label for="projectTitleInput" class="block mb-2 font-semibold text-gray-300 text-sm">Judul / Topik Proyek:</label>
                        <div class="flex flex-col md:flex-row items-stretch gap-2">
                            <input id="projectTitleInput" type="text" placeholder="Contoh: Proses Terjadinya Hujan untuk SD" class="flex-grow bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-cyan-500 focus:border-cyan-500 text-white placeholder-gray-500">
                            <button id="generateScriptBtn" class="btn btn-ai font-semibold py-3 px-6 rounded-lg text-sm whitespace-nowrap hidden md:flex items-center justify-center gap-2 shadow-lg shadow-cyan-900/20">
                                <span id="generateScriptBtnText">Buat Naskah Otomatis</span>
                                <div id="scriptLoader" class="inline-loader hidden"></div>
                            </button>
                             <button id="generateScriptBtnMobile" class="btn btn-ai font-semibold py-3 px-6 rounded-lg text-sm whitespace-nowrap md:hidden flex items-center justify-center gap-2 shadow-lg shadow-cyan-900/20">
                                <span>Buat Naskah</span>
                            </button>
                        </div>
                    </div>
                    <div class="relative flex-grow flex flex-col">
                        <label for="scenarioInput" class="block mb-2 font-semibold text-gray-300 text-sm">Naskah Cerita Lengkap:</label>
                        <textarea id="scenarioInput" rows="12" placeholder="Tuliskan atau tempelkan (paste) seluruh naskah cerita Anda di sini. AI akan menganalisis dan membaginya menjadi beberapa segmen video." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 focus:ring-cyan-500 focus:border-cyan-500 text-gray-200 leading-relaxed resize-none"></textarea>
                    </div>
                     <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <div class="flex flex-col md:flex-row items-center gap-4 justify-between">
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <label for="sceneCount" class="block text-sm font-semibold text-gray-300 whitespace-nowrap">Jumlah Segmen:</label>
                                <input type="number" id="sceneCount" min="1" max="20" value="3" class="w-20 bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white focus:ring-cyan-500 focus:border-cyan-500">
                                <button id="analyzeTextBtn" class="btn btn-secondary text-xs font-semibold py-2 px-3 rounded-lg whitespace-nowrap">Hitung Saran</button>
                            </div>
                             <button id="generateBtn" class="btn btn-primary font-bold py-3 px-8 text-lg rounded-xl shadow-lg w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105" disabled>
                                BUAT PAPAN CERITA! ðŸš€
                            </button>
                        </div>
                     </div>
                </div>

                <div id="storyboardView" class="p-6 hidden bg-gray-900/20 h-full overflow-y-auto">
                    <div id="loader" class="mx-auto loader hidden mb-8 mt-4"></div>
                    <div id="storyboardOutput" class="space-y-8 pb-10">
                        <div id="results-placeholder" class="flex flex-col items-center justify-center py-20 text-gray-600 opacity-60">
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-easel2 mb-4" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 0a.5.5 0 0 1 .447.276l.548.932 4.2 7.14a.5.5 0 0 1-.447.752H2.253a.5.5 0 0 1-.447-.752l4.2-7.14L7.553.276A.5.5 0 0 1 8 0zM8 2.366 4.636 8.5h6.728L8 2.366z"/><path d="M.5 11a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm-10.56 3.53a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L2.5 15.293l1.646-1.647a.5.5 0 0 1 .708 0zM14.06 14.53a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L11.5 15.293l1.646-1.647a.5.5 0 0 1 .708 0z"/></svg>
                            <h3 class="text-2xl font-bold mb-2">Papan Cerita Kosong</h3>
                            <p class="text-sm">Isi naskah cerita dan klik tombol buat untuk melihat keajaiban.</p>
                        </div>
                    </div>
                </div>
                
            </main>
        </div>
    </div>
    
    <!-- Character Modal -->
    <div id="characterModal" class="custom-modal-overlay">
        <div class="custom-modal-content border-cyan-500/30">
            <div class="flex justify-between items-center mb-6">
                <h2 id="characterModalTitle" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-sky-400 futuristic-text-glow">Studio Tokoh 3D</h2>
                <button id="closeCharModalIcon" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            
            <div id="char-step1" class="flex-grow flex flex-col">
                 <p class="text-center text-gray-400 mb-6 text-sm">Langkah 1/3: Unggah gambar referensi atau deskripsikan tokoh Anda.</p>
                 <input type="file" id="charImageInput" class="hidden" accept="image/*">
                 <div class="flex gap-4 mb-4">
                     <div id="charImagePreview" class="w-1/3 aspect-square rounded-lg bg-gray-800 border-2 border-dashed border-gray-600 flex items-center justify-center text-gray-500 cursor-pointer hover:border-cyan-500 transition-colors relative overflow-hidden group">
                         <span class="z-10 text-center text-xs p-2">Klik untuk Unggah Foto</span>
                         <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center z-20"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg></div>
                     </div>
                     <textarea id="charIdeaInput" placeholder="Deskripsikan tokoh. Contoh: 'Seorang pangeran muda pemberani dengan rambut emas dan baju zirah biru masa depan.'" class="w-2/3 bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-cyan-500 text-sm resize-none"></textarea>
                 </div>
                <button id="developCharBtn" class="btn btn-ai font-semibold py-3 px-6 rounded-lg w-full mt-auto flex items-center justify-center gap-2 shadow-lg shadow-cyan-500/20">
                    <span id="developCharBtnText">âœ¨ Analisis & Desain Model</span>
                    <div id="charLoader" class="inline-loader hidden"></div>
                </button>
            </div>

            <div id="char-step2" class="hidden flex-grow overflow-y-auto pr-2 custom-scrollbar">
                <p class="text-center text-gray-400 mb-4 text-sm">Langkah 2/3: Periksa detil karakter hasil analisis AI.</p>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Panggilan</label>
                            <input type="text" id="charBrandName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Peran</label>
                            <input type="text" id="charModelName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ID Konsistensi (Prompt ID)</label>
                        <input type="text" id="charConsistencyKey" class="w-full bg-gray-900 border border-cyan-900 rounded-lg p-2 text-cyan-400 font-mono text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Deskripsi Visual Lengkap</label>
                        <textarea id="charDesignLanguage" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-sm h-24 text-gray-300"></textarea>
                    </div>
                </div>
            </div>

            <div id="char-step3" class="hidden flex-grow overflow-y-auto pr-2 custom-scrollbar">
                <p class="text-center text-gray-400 mb-4 text-sm">Langkah 3/3: Tentukan DNA Aksi.</p>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Saran AI:</label>
                    <div id="actionDnaSuggestions" class="flex flex-wrap gap-2 mb-4"></div>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="customActionDnaInput" placeholder="Tambah aksi manual..." class="flex-grow bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm">
                    <button id="addCustomDnaBtn" class="btn btn-secondary px-3 rounded-lg">+</button>
                </div>
                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700 min-h-[60px]">
                     <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Aksi Terpilih:</label>
                     <div id="selectedActionDna" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-700">
                 <button id="closeCharModalBtn" class="btn btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Batal</button>
                 <div class="flex gap-2">
                     <button id="charPrevBtn" class="btn btn-secondary text-sm font-semibold py-2 px-4 rounded-lg hidden">Kembali</button>
                     <button id="charNextBtn" class="btn btn-primary text-sm font-semibold py-2 px-4 rounded-lg hidden">Lanjut</button>
                     <button id="addCharBtn" class="btn btn-success text-sm font-semibold py-2 px-6 rounded-lg hidden shadow-lg shadow-green-900/20">Simpan Tokoh</button>
                 </div>
            </div>
        </div>
    </div>
        
    <!-- Settings Modal -->
    <div id="settingsModal" class="custom-modal-overlay">
        <div class="custom-modal-content max-w-md">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1 0 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105 0l.17.31c.698 1.283 2.686.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 0-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105 0l-.17-.31zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                Pengaturan API
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="apiKeyInput" class="block text-sm font-semibold text-gray-400 mb-1">Google AI Studio API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="Tempel API Key di sini..." class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 pr-10 text-sm focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
                        <button type="button" id="toggle-api-key" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-cyan-400">
                             <svg id="eye-icon-apikey" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                             <svg id="eye-slash-icon-apikey" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-eye-slash-fill hidden" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Diperlukan untuk fitur AI. Key disimpan di browser Anda (LocalStorage).
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-cyan-400 hover:underline">Dapatkan Key Gratis</a>.
                    </p>
                </div>
            </div>
            <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-700">
                <button id="clearApiKeyBtn" class="text-red-400 hover:text-red-300 text-xs font-semibold">Hapus Key</button>
                <div class="flex gap-2">
                    <button id="closeSettingsModalBtn" class="btn btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Batal</button>
                    <button id="saveApiKeyBtn" class="btn btn-primary text-sm font-semibold py-2 px-6 rounded-lg">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationModal" class="fixed bottom-5 right-5 bg-gray-800 border border-cyan-500/50 text-white py-3 px-5 rounded-lg shadow-2xl hidden fade-in max-w-sm flex items-center gap-3 z-50">
        <div class="h-2 w-2 rounded-full bg-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.8)]"></div>
        <p id="notificationText" class="text-sm font-medium"></p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="custom-modal-overlay">
        <div class="custom-modal-content max-w-sm text-center">
            <h3 id="confirmationTitle" class="text-xl font-bold text-white mb-2">Konfirmasi</h3>
            <p id="confirmationMessage" class="text-gray-400 mb-6 text-sm">Apakah Anda yakin?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="btn btn-secondary font-semibold py-2 px-6 rounded-lg text-sm">Batal</button>
                <button id="confirmOkBtn" class="btn btn-primary font-semibold py-2 px-6 rounded-lg text-sm">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <script>
    // --- ENVIRONMENT CONFIG ---
    // Placeholder for environment variable if used in a specific runner, 
    // otherwise the user manually inputs the key in the Settings UI.
    const apiKey = ""; 

    document.addEventListener('DOMContentLoaded', () => {
        // --- PASSWORD PROTECTION ---
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const appWrapperEl = document.getElementById('app-wrapper');
        const CORRECT_PASSWORD = 'SUKSES2025';

        const showApp = () => {
            passwordOverlay.style.display = 'none';
            appWrapperEl.style.display = 'block';
        };

        if (sessionStorage.getItem('isVerified_EduPixar') === 'true') {
            showApp();
        } else {
            passwordOverlay.style.display = 'flex';
        }

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('isVerified_EduPixar', 'true');
                showApp();
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });

        // --- STATE & CONSTANTS ---
        let characters = []; 
        let storyboardData = []; 
        let userApiKey = '';
        let currentCharacterModalStep = 1;
        let isEditingCharacter = false;
        let editingCharacterIndex = -1;
        let uploadedImageBase64 = null;
        let uploadedImageType = null;
        let tempDevelopedChar = null;

        // Model version updated to latest stable preview
        const AI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        const templateCharacters = [
            {
                name: "Pak Didik (Mentor Cerdas)", brandName: "Pak Didik", modelName: "Mentor Cerdas",
                description: "Seorang pak guru chibi yang cerdas dan bijaksana, dengan kacamata bulat dan mata besar yang berbinar. Rambutnya pendek disisir ke kanan. Ia mengenakan kemeja dan celana warna khaki, lengkap dengan sebuah ikat pinggang dan sepatu berwarna hitam. memakai sebuah jam tangan hitam di pergelangan tangan. Di dada tersemat sebuah papan nama kecil bertuliskan \"Pak DIDIK\". Ia memancarkan aura pendidik yang ramah dan berpengetahuan luas.",
                consistency_key: "pixar_teacher_didik_v1",
                actionDNA: ["Menjelaskan dengan sabar", "Memberi contoh nyata", "Tersenyum ramah"]
            },
            {
                name: "Bu Aminah (Guru Sabar)", brandName: "Bu Aminah", modelName: "Guru Sabar",
                description: "Seorang guru wanita gaya 3D Pixar yang keibuan, dengan senyum hangat. Ia mengenakan jilbab sederhana berwarna pastel yang membuatnya terlihat sangat lembut dan sabar.",
                consistency_key: "pixar_teacher_aminah_v1",
                actionDNA: ["Membimbing dengan lembut", "Memberi pujian", "Bercerita"]
            },
            {
                name: "Adi (Siswa Petualang)", brandName: "Adi", modelName: "Siswa Petualang",
                description: "Seorang siswa laki-laki gaya 3D Pixar yang energik, dengan mata besar penuh rasa ingin tahu. Dia mengenakan seragam sekolah putih-merah yang rapi namun terlihat nyaman untuk bergerak aktif.",
                consistency_key: "pixar_student_adi_v1",
                actionDNA: ["Mengangkat tangan", "Bertanya", "Mencoba eksperimen", "Terlihat bingung"]
            },
            {
                name: "Zara (Siswi Ceria)", brandName: "Zara", modelName: "Siswi Ceria",
                description: "Karakter siswi gaya 3D Pixar yang ceria. Karakter mengenakan seragam sekolah dasar Indonesia, terdiri dari kerudung putih, kemeja putih lengan panjang, dasi merah, dan rok merah panjang menutupi kaos kaki. Wajah bulat dengan mata besar, pipi merona, dan ekspresi senyum manis.",
                consistency_key: "pixar_student_zara_v1",
                actionDNA: ["Tersenyum gembira", "Berkolaborasi dengan teman", "Menunjukkan hasil kerja"]
            }
        ];

        const PIXAR_STYLE_KEYWORDS = {
            style: "3D Disney Pixar style, Pixar animation, high-quality render, expressive characters, soft lighting, vibrant colors, detailed textures, cinematic, heart-warming, whimsical, charming",
            negative: "2D, flat, anime, realistic, photorealistic, low-poly, scary, horror, dark, dull colors, text, watermark, deformed, ugly, macabre"
        };
        
        const defaultState = { 
            projectTitle: '',
            scenario: '', 
            sceneCount: 3, 
            locationSet: 'ruang_kelas',
            customLocation: '',
            cameraStyleSet: 'standard_cinematic',
            narratorVoiceSet: 'pria_dewasa_ramah'
        };
        let state = { ...defaultState };

        // --- DOM Elements ---
        const projectTitleInput = document.getElementById('projectTitleInput');
        const generateScriptBtn = document.getElementById('generateScriptBtn');
        const generateScriptBtnMobile = document.getElementById('generateScriptBtnMobile');
        const generateScriptBtnText = document.getElementById('generateScriptBtnText');
        const scriptLoader = document.getElementById('scriptLoader');
        const charListContainer = document.getElementById('charListContainer');
        const templateCharList = document.getElementById('templateCharList');
        const scenarioInput = document.getElementById('scenarioInput');
        const sceneCountInput = document.getElementById('sceneCount');
        const analyzeTextBtn = document.getElementById('analyzeTextBtn');
        const generateBtn = document.getElementById('generateBtn');
        const storyboardOutput = document.getElementById('storyboardOutput');
        const loader = document.getElementById('loader');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const locationSetInput = document.getElementById('locationSet');
        const customLocationInput = document.getElementById('customLocationInput');
        const cameraStyleSetInput = document.getElementById('cameraStyleSet');
        const narratorLanguageSetInput = document.getElementById('narratorLanguageSet');
        const customNarratorLanguageInput = document.getElementById('customNarratorLanguageInput');
        const narratorVoiceSetInput = document.getElementById('narratorVoiceSet');
        const selectedNarratorStyleText = document.getElementById('selectedNarratorStyleText');
        const characterModal = document.getElementById('characterModal');
        const characterModalTitle = document.getElementById('characterModalTitle');
        const openAddCharModalBtn = document.getElementById('openAddCharModalBtn');
        const charStep1 = document.getElementById('char-step1');
        const charStep2 = document.getElementById('char-step2');
        const charStep3 = document.getElementById('char-step3');
        const developCharBtn = document.getElementById('developCharBtn');
        const developCharBtnText = document.getElementById('developCharBtnText');
        const charLoader = document.getElementById('charLoader');
        const addCharBtn = document.getElementById('addCharBtn');
        const closeCharModalBtn = document.getElementById('closeCharModalBtn');
        const closeCharModalIcon = document.getElementById('closeCharModalIcon');
        const charPrevBtn = document.getElementById('charPrevBtn');
        const charNextBtn = document.getElementById('charNextBtn');
        const charBrandNameInput = document.getElementById('charBrandName');
        const charModelNameInput = document.getElementById('charModelName');
        const charConsistencyKeyInput = document.getElementById('charConsistencyKey');
        const charDesignLanguageInput = document.getElementById('charDesignLanguage');
        const actionDnaSuggestions = document.getElementById('actionDnaSuggestions');
        const customActionDnaInput = document.getElementById('customActionDnaInput');
        const addCustomDnaBtn = document.getElementById('addCustomDnaBtn');
        const selectedActionDna = document.getElementById('selectedActionDna');
        const charImageInput = document.getElementById('charImageInput');
        const charImagePreview = document.getElementById('charImagePreview');
        const charIdeaInput = document.getElementById('charIdeaInput');
        const tabNaskah = document.getElementById('tabNaskah');
        const tabStoryboard = document.getElementById('tabStoryboard');
        const naskahView = document.getElementById('naskahView');
        const storyboardView = document.getElementById('storyboardView');
        const resetProjectBtn = document.getElementById('resetProjectBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
        const importProjectBtn = document.getElementById('importProjectBtn');
        const exportProjectBtn = document.getElementById('exportProjectBtn');
        const importFileInput = document.getElementById('importFileInput');
        
        // --- CORE API FUNCTION ---
        const callGeminiAPI = async (prompt, schema = null, model = AI_MODEL, imageBase64 = null, imageType = null) => {
            // Prioritize user key from settings, fall back to environment key
            const currentKey = userApiKey || apiKey;
            
            if (!currentKey) {
                showNotification("API Key belum diatur. Silakan buka Pengaturan.");
                throw new Error("API Key Missing");
            }

            let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`;
            
            let parts = [{ text: prompt }];
            if (imageBase64 && imageType) {
                parts.unshift({ inlineData: { mimeType: imageType, data: imageBase64 } });
            }
            
            let payload = { contents: [{ role: "user", parts: parts }] };
            if (schema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
            }

            let response;
            let delay = 1000;
            // Exponential backoff logic
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) break;
                    if (response.status === 429) { await new Promise(resolve => setTimeout(resolve, delay)); delay *= 2; } 
                    else {
                        const errorBody = await response.json();
                        throw new Error(errorBody.error?.message || 'Unknown error');
                    }
                } catch (e) {
                    if (i === 2) throw e;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            if (!response || !response.ok) throw new Error(`Gagal menghubungi AI. Periksa koneksi atau API Key.`);
            const result = await response.json();
            
            const candidate = result.candidates?.[0];

            if (!candidate) {
                 if (result.error) throw new Error(`API Error: ${result.error.message}`);
                 throw new Error("Tidak ada respon dari AI. Prompt mungkin diblokir keamanan.");
            }

            const text = candidate.content?.parts?.[0]?.text;
            
            if (typeof text !== 'string' || (schema && text.trim() === '')) {
                 throw new Error("Format respon AI tidak valid.");
            }
            
            return text;
        };
        
        // --- UI & RENDER FUNCTIONS ---
        const showNotification = (text, duration = 4000) => {
            const modal = document.getElementById('notificationModal');
            document.getElementById('notificationText').textContent = text;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('hidden'), duration);
        };

        const showConfirmation = (title, message) => {
            return new Promise((resolve) => {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmationModal.classList.add('visible');
                const cleanupAndResolve = (value) => {
                    confirmationModal.classList.remove('visible');
                    resolve(value);
                };
                confirmOkBtn.onclick = () => cleanupAndResolve(true);
                confirmCancelBtn.onclick = () => cleanupAndResolve(false);
            });
        };

        const updateNarratorLockDisplay = () => {
            const selectedOption = narratorVoiceSetInput.options[narratorVoiceSetInput.selectedIndex];
            selectedNarratorStyleText.textContent = selectedOption.text;
        };

        const updateUIState = () => { 
            generateBtn.disabled = !(state.scenario.trim() !== '');
        };
        
        const renderCharacters = () => {
            charListContainer.innerHTML = characters.length === 0 ? '<p class="text-gray-500 italic text-xs text-center py-2">Belum ada tokoh.</p>' : '';
            characters.forEach((char, index) => {
                const charElement = document.createElement('div');
                charElement.className = 'bg-gray-800 p-3 rounded-lg flex items-center justify-between fade-in border border-gray-700 hover:border-cyan-500/50 transition-colors';
                charElement.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-cyan-400 text-sm">${char.brandName}</p>
                        <p class="text-[10px] text-gray-400">${char.modelName}</p>
                    </div>
                    <div class="flex gap-2">
                         <button data-index="${index}" class="edit-char-btn text-gray-400 hover:text-cyan-300 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                         <button data-index="${index}" class="remove-char-btn text-gray-400 hover:text-red-400 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                    </div>`;
                charListContainer.appendChild(charElement);
            });
            updateUIState();
        };

        const renderTemplateCharacters = () => {
            templateCharList.innerHTML = '';
            templateCharacters.forEach((char, index) => {
                const charElement = document.createElement('div');
                charElement.className = 'bg-gray-800/60 p-2 rounded-lg flex items-center justify-between border border-transparent hover:border-cyan-500/30 transition-all';
                charElement.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-300 text-xs">${char.brandName}</p>
                    </div>
                    <button data-index="${index}" class="add-template-char-btn btn btn-ai text-[10px] font-semibold py-1 px-2 rounded-md">+ Add</button>
                `;
                templateCharList.appendChild(charElement);
            });
        };

        const createSceneCard = (scene, index) => {
            const sceneEl = document.createElement('div');
            sceneEl.className = `scene-card bg-gray-800 border border-gray-700 p-5 rounded-xl shadow-lg fade-in relative overflow-hidden group`;
            sceneEl.dataset.index = index;

            const narrationHtml = (scene.sound_design?.narration_script) 
                ? `<div class="mt-3 pt-3 border-t border-gray-700/50"><p class="text-sm text-gray-400 italic font-serif">"${scene.sound_design.narration_script}"</p></div>` : '';
            const sfxList = scene.sound_design?.sfx?.length > 0
                ? `<ul class="suggestion-list text-sm mt-1 space-y-1">${scene.sound_design.sfx.map(sfx => `<li><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.5 2a.5.5 0 0 1 .5.5v11a.5.5 0 0 1-1 0v-11a.5.5 0 0 1 .5-.5zm-2 2a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm-6 1.5A.5.5 0 0 1 5 6v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm8 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm-10 1A.5.5 0 0 1 3 7v2a.5.5 0 0 1-1 0V7a.5.5 0 0 1 .5-.5zm12 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V7a.5.5 0 0 1 .5-.5z"/></svg> <span class="text-gray-400">${sfx}</span></li>`).join('')}</ul>` : '<p class="text-sm text-gray-500 mt-1 italic">Tidak ada SFX.</p>';
            
            sceneEl.innerHTML = `
                <div class="absolute top-0 right-0 p-4 opacity-50 text-6xl font-black text-gray-700 pointer-events-none select-none -z-0">${scene.scene_number}</div>
                <div class="relative z-10">
                    <div class="flex items-start gap-4">
                        <div class="bg-cyan-900/40 text-cyan-400 font-bold rounded-lg w-12 h-12 flex items-center justify-center text-xl flex-shrink-0 border border-cyan-500/30">
                            ${scene.scene_number}
                        </div>
                        <div class="w-full">
                            <h4 class="text-lg font-bold text-cyan-400 mb-1 leading-tight">${scene.scene_title || `Segmen Belajar ${index + 1}`}</h4>
                            <p class="text-gray-300 text-sm leading-relaxed">${scene.scene_summary}</p>
                            
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-900/30 p-3 rounded-lg">
                                <div>
                                    <h5 class="font-semibold text-gray-500 text-xs uppercase mb-1 flex items-center gap-1">ðŸŽ¥ Visual & Kamera</h5>
                                    <p class="text-xs text-gray-400">${scene.cinematography?.shot_type || 'N/A'} â€¢ ${scene.cinematography?.camera_angle || 'N/A'}</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-500 text-xs uppercase mb-1 flex items-center gap-1">ðŸ”Š Audio FX</h5>
                                    ${sfxList}
                                </div>
                            </div>
                            ${narrationHtml}
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700 flex flex-wrap gap-2 justify-end">
                         <button data-index="${index}" class="generate-blueprint-btn btn btn-secondary text-xs font-semibold py-2 px-3 rounded-lg flex items-center gap-2 hover:bg-gray-600">
                            <span>Video Prompt</span>
                         </button>
                         <button data-index="${index}" class="generate-canva-prompt-btn btn btn-prompt-canva text-xs font-semibold py-2 px-3 rounded-lg flex items-center gap-2">
                            <span>Canva Prompt</span>
                         </button>
                         <button data-index="${index}" class="generate-timecode-btn btn btn-success text-xs font-semibold py-2 px-3 rounded-lg flex items-center gap-2">
                            <span>JSON Timecode</span>
                         </button>
                    </div>
                    
                    <div class="prompt-results-grid grid grid-cols-1 gap-3 mt-0">
                         <div class="blueprint-prompt-container mt-2 empty:hidden"></div>
                         <div class="canva-prompt-container mt-2 empty:hidden"></div>
                         <div class="timecode-script-container mt-2 empty:hidden"></div>
                    </div>
                </div>`;
            return sceneEl;
        };

        const renderStoryboard = (data) => {
            storyboardOutput.innerHTML = '';
            if (!data || data.length === 0) {
                if (document.getElementById('tabStoryboard').classList.contains('active')) {
                    storyboardOutput.appendChild(resultsPlaceholder);
                    resultsPlaceholder.classList.remove('hidden');
                }
                return;
            }
            resultsPlaceholder.classList.add('hidden');
            data.forEach((scene, index) => storyboardOutput.appendChild(createSceneCard(scene, index)));
        };
        
        // --- CORE LOGIC FUNCTIONS ---
        const handleGenerateScript = async () => {
            const topic = projectTitleInput.value.trim();
            if (topic === '') {
                showNotification("Silakan masukkan judul atau topik terlebih dahulu.");
                return;
            }
            generateScriptBtn.disabled = true;
            generateScriptBtnMobile.disabled = true;
            scriptLoader.classList.remove('hidden');
            generateScriptBtnText.textContent = 'Memproses...';
            
            const prompt = `Anda adalah penulis naskah pendidikan. Buat **rangkuman materi terstruktur** topik: "${topic}". Naskah harus:
1. Singkat, padat, cocok untuk anak SD.
2. Dibagi menjadi 3 paragraf logis (Intro, Isi, Penutup).
3. Bahasa sederhana dan menarik.`;
            
            try {
                const resultText = await callGeminiAPI(prompt);
                scenarioInput.value = resultText;
                state.scenario = resultText;
                updateUIState();
                showNotification("Naskah berhasil dibuat!");
                handleAnalyzeText(); 
            } catch (error) {
                showNotification(`Gagal: ${error.message}`);
            } finally {
                generateScriptBtn.disabled = false;
                generateScriptBtnMobile.disabled = false;
                scriptLoader.classList.add('hidden');
                generateScriptBtnText.textContent = 'Buat Naskah Otomatis';
            }
        };

        const handleAnalyzeText = () => {
            const text = scenarioInput.value;
            if (text.trim() === '') {
                showNotification("Tulis naskah cerita terlebih dahulu.");
                return;
            }
            const wordCount = text.trim().split(/\s+/).length;
            const suggestedScenes = Math.max(1, Math.min(20, Math.ceil(wordCount / 25))); 
            sceneCountInput.value = suggestedScenes;
            state.sceneCount = suggestedScenes;
            showNotification(`Saran: ${suggestedScenes} segmen.`);
        };
        
        const handleGenerateStoryboard = async () => {
            loader.classList.remove('hidden');
            resultsPlaceholder.classList.add('hidden');
            storyboardOutput.innerHTML = '';
            switchTab(tabStoryboard, storyboardView);

            const characterDetails = characters.length > 0 ? `Gunakan tokoh cerita (Pastikan visual konsisten): ${JSON.stringify(characters.map(c => ({ name: c.name, description: c.description, consistency_key: c.consistency_key })), null, 2)}` : "Tidak ada tokoh spesifik.";
            
            let locationContext = `Latar: ${locationSetInput.options[locationSetInput.selectedIndex].text}.`;
            if (locationSetInput.value === 'custom_location') locationContext = `Latar: ${customLocationInput.value.trim()}.`;
            
            const narratorLanguage = narratorLanguageSetInput.value === 'custom_language' ? customNarratorLanguageInput.value.trim() : narratorLanguageSetInput.value;
            const narratorLangText = narratorLanguageSetInput.options[narratorLanguageSetInput.selectedIndex].text;
            
            let narrationInstruction;
            if (narratorLanguage === 'no_narrator') {
                narrationInstruction = `* 'narration_script' HARUS dikosongkan.`;
            } else if (narratorVoiceSetInput.value === 'dialog_murni') {
                narrationInstruction = `* 'narration_script' berisi DIALOG karakter. Bahasa ${narratorLangText}.`;
            } else {
                narrationInstruction = `* 'narration_script' adalah NARASI pendek (max 20 kata). Bahasa ${narratorLangText}.`;
            }

            const prompt = `Anda adalah AI Storyboard Artist. Ubah naskah menjadi papan cerita JSON.
**Naskah:** \`\`\`${state.scenario}\`\`\`
**Target:** ${state.sceneCount} Segmen.
**Gaya:** 3D Disney Pixar (Wajib).
**Karakter:** ${characterDetails}
**Konteks:** ${locationContext}, Kamera: ${cameraStyleSetInput.value}.
**Output JSON:** Array 'storyboard' berisi objek (scene_number, scene_title, scene_summary, cinematography (shot_type, camera_angle), sound_design (sfx array, narration_script)).
${narrationInstruction}
Pastikan alur cerita logis.`;
            
            const masterSceneObjectSchema = {
                type: "OBJECT", properties: {
                    scene_number: { type: "NUMBER" }, scene_title: { type: "STRING" }, scene_summary: { type: "STRING" },
                    cinematography: { type: "OBJECT", properties: { shot_type: { type: "STRING" }, camera_angle: { type: "STRING" } } },
                    sound_design: { type: "OBJECT", properties: { sfx: { type: "ARRAY", items: { type: "STRING" } }, narration_script: { type: "STRING" } } }
                }, required: ["scene_number", "scene_title", "scene_summary"]
            };

            const schema = { type: "OBJECT", properties: { storyboard: { type: "ARRAY", items: masterSceneObjectSchema } }, required: ["storyboard"] };

            try {
                const resultText = await callGeminiAPI(prompt, schema);
                const parsedResult = JSON.parse(resultText);
                storyboardData = parsedResult.storyboard;
                renderStoryboard(storyboardData);
            } catch (error) {
                console.error(error);
                storyboardOutput.innerHTML = `<div class="text-center p-8 bg-red-900/20 rounded-xl border border-red-500/50"><p class="text-red-400">Gagal membuat papan cerita: ${error.message}</p></div>`;
            } finally { loader.classList.add('hidden'); }
        };

        const handleGenerateBlueprint = async (e) => {
            const button = e.target.closest('.generate-blueprint-btn');
            if (!button) return;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="inline-loader w-4 h-4 border-2"></div>';
            button.disabled = true;

            const card = button.closest('.scene-card');
            const sceneIndex = parseInt(card.dataset.index, 10);
            const sceneData = storyboardData[sceneIndex];
            const container = card.querySelector('.blueprint-prompt-container');
            
            const characterInScene = characters.find(c => sceneData.scene_summary.toLowerCase().includes(c.brandName.toLowerCase()));
            const characterDNA = characterInScene ? `CHARACTER: {ID: "${characterInScene.consistency_key}", Desc: "${characterInScene.description}"}.` : '';
            
            const prompt = `Generate a high-end text-to-video prompt (English).
STYLE: ${PIXAR_STYLE_KEYWORDS.style}
SCENE: ${sceneData.scene_summary}
${characterDNA}
FORMAT:
STYLE: [Keywords]
SUBJECT: [Detailed Description]
LIGHTING: [Atmosphere]
NEGATIVE: ${PIXAR_STYLE_KEYWORDS.negative}`;

            try {
                let result = await callGeminiAPI(prompt);
                renderScenePrompt(result, container, 'Video Gen Prompt (Sora/Veo/Runway)');
            } catch (error) {
                renderScenePrompt(`Error: ${error.message}`, container, 'Error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };

        const handleGenerateCanvaPrompt = async (e) => {
            const button = e.target.closest('.generate-canva-prompt-btn');
            if (!button) return;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="inline-loader w-4 h-4 border-2"></div>';
            button.disabled = true;

            const card = button.closest('.scene-card');
            const sceneIndex = parseInt(card.dataset.index, 10);
            const sceneData = storyboardData[sceneIndex];
            const container = card.querySelector('.canva-prompt-container');
            
            const characterInScene = characters.find(c => sceneData.scene_summary.toLowerCase().includes(c.brandName.toLowerCase()));
            const characterContext = characterInScene ? `Karakter: "${characterInScene.name}" (${characterInScene.description}).` : '';

            const prompt = `Buat 1 prompt Canva Magic Media (Bahasa Indonesia).
SCENE: "${sceneData.scene_summary}"
${characterContext}
GAYA: 3D Disney Pixar.
Output: Hanya string prompt, 10-20 kata kunci.`;

            try {
                let result = await callGeminiAPI(prompt);
                renderScenePrompt(result, container, 'Prompt Canva Magic Media');
            } catch (error) {
                renderScenePrompt(`Error: ${error.message}`, container, 'Error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };
        
        const handleGenerateTimecodeScript = async (e) => {
            const button = e.target.closest('.generate-timecode-btn');
            if (!button) return;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="inline-loader w-4 h-4 border-2"></div>';
            button.disabled = true;

            const card = button.closest('.scene-card');
            const sceneIndex = parseInt(card.dataset.index, 10);
            const sceneData = storyboardData[sceneIndex];
            const container = card.querySelector('.timecode-script-container');
            
            const prompt = `Create a JSON timeline script (8s duration).
Scene: ${JSON.stringify(sceneData)}
Style: 3D Pixar.
Output JSON schema: { total_duration_seconds: number, timeline: [{ timestamp: string, visual: string, camera: string }] }`;
            
            const schema = {
                type: "OBJECT", properties: {
                    total_duration_seconds: { type: "NUMBER" },
                    timeline: { type: "ARRAY", items: { type: "OBJECT", properties: {
                        timestamp: { type: "STRING" }, visual: { type: "STRING" }, camera: { type: "STRING" }
                    }}}
                }
            };

            try {
                const resultText = await callGeminiAPI(prompt, schema);
                renderScenePrompt(resultText, container, 'JSON Timecode');
            } catch (error) {
                renderScenePrompt(`Error: ${error.message}`, container, 'Error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };

        const renderScenePrompt = (promptText, container, title) => {
            const promptId = `prompt-${Date.now()}`;
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg border border-gray-600 overflow-hidden">
                    <div class="flex justify-between items-center px-3 py-1 bg-gray-700/50 border-b border-gray-600">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">${title}</span>
                        <button class="btn-copy text-xs px-2 py-0.5 rounded hover:bg-gray-600 text-cyan-400 transition-colors" data-copy-target-id="${promptId}">Salin</button>
                    </div>
                    <pre id="${promptId}" class="prompt-output p-3 text-xs">${promptText}</pre>
                </div>`;
        };

        const handleDevelopCharacter = async () => {
            const idea = charIdeaInput.value.trim();
            if (!idea && !uploadedImageBase64) {
                showNotification("Unggah gambar atau deskripsikan tokoh."); return;
            }
            developCharBtn.disabled = true;
            charLoader.classList.remove('hidden');
            developCharBtnText.textContent = "Menganalisis...";
            
            const prompt = `Analyze image/description: "${idea}". Create 3D Pixar Character Model Sheet (JSON).
Rules: 'brand_name' (Short, Indonesian), 'consistency_key' (English ID), 'design_language' (Detailed Indonesian desc).`;
            
            const schema = {
                type: "OBJECT", properties: {
                    brand_name: { type: "STRING" }, model_name: { type: "STRING" },
                    design_language: { type: "STRING" }, consistency_key: { type: "STRING" }
                }, required: ["brand_name", "model_name", "design_language", "consistency_key"]
            };

            try {
                const resultText = await callGeminiAPI(prompt, schema, AI_MODEL, uploadedImageBase64, uploadedImageType);
                tempDevelopedChar = JSON.parse(resultText);
                charBrandNameInput.value = tempDevelopedChar.brand_name;
                charModelNameInput.value = tempDevelopedChar.model_name;
                charConsistencyKeyInput.value = tempDevelopedChar.consistency_key;
                charDesignLanguageInput.value = tempDevelopedChar.design_language;
                switchCharacterModalStep(2);
            } catch (error) {
                showNotification(`Gagal: ${error.message}`);
            } finally {
                developCharBtn.disabled = false;
                charLoader.classList.add('hidden');
                developCharBtnText.textContent = "âœ¨ Analisis & Desain Model";
            }
        };

        const handleSaveCharacter = () => {
            const brand = charBrandNameInput.value.trim();
            const model = charModelNameInput.value.trim();
            const consistencyKey = charConsistencyKeyInput.value.trim();
            
            if (!brand || !model) { showNotification('Nama dan Peran wajib diisi.'); return; }
            
            const characterData = {
                name: `${brand} (${model})`, brandName: brand, modelName: model, 
                description: charDesignLanguageInput.value.trim(),
                consistency_key: consistencyKey, 
                actionDNA: Array.from(selectedActionDna.querySelectorAll('.action-dna-tag')).map(tag => tag.textContent.replace(' Ã—', ''))
            };

            if (isEditingCharacter) {
                characters[editingCharacterIndex] = characterData;
                showNotification(`Tokoh diperbarui!`);
            } else {
                characters.push(characterData);
                showNotification(`Tokoh disimpan!`);
            }
            renderCharacters();
            characterModal.classList.remove('visible');
        };

        // --- NAVIGATION & INIT ---
        const switchTab = (activeTab, activeView) => {
            [tabNaskah, tabStoryboard].forEach(t => t.classList.remove('active'));
            [naskahView, storyboardView].forEach(v => v.classList.add('hidden'));
            activeTab.classList.add('active'); activeView.classList.remove('hidden');
        };

        const switchCharacterModalStep = async (step) => {
            currentCharacterModalStep = step;
            [charStep1, charStep2, charStep3].forEach(s => s.classList.add('hidden'));
            charPrevBtn.classList.add('hidden'); charNextBtn.classList.add('hidden'); addCharBtn.classList.add('hidden');
            
            if (step === 1) charStep1.classList.remove('hidden');
            else if (step === 2) { charStep2.classList.remove('hidden'); charPrevBtn.classList.remove('hidden'); charNextBtn.classList.remove('hidden'); }
            else if (step === 3) { 
                charStep3.classList.remove('hidden'); charPrevBtn.classList.remove('hidden'); addCharBtn.classList.remove('hidden'); 
                if (!isEditingCharacter && (!tempDevelopedChar?.actionDNA)) await handleGenerateActionDNA(); 
            }
        };
        
        const resetCharModal = () => {
            isEditingCharacter = false; editingCharacterIndex = -1; charIdeaInput.value = ''; tempDevelopedChar = null; uploadedImageBase64 = null;
            charImagePreview.innerHTML = '<span class="z-10 text-center text-xs p-2">Klik untuk Unggah Foto</span>'; charImageInput.value = '';
            characterModalTitle.textContent = "Studio Tokoh 3D"; addCharBtn.textContent = "Simpan Tokoh";
            charBrandNameInput.value = ''; charModelNameInput.value = ''; charConsistencyKeyInput.value = ''; charDesignLanguageInput.value = '';
            actionDnaSuggestions.innerHTML = ''; selectedActionDna.innerHTML = ''; customActionDnaInput.value = '';
            switchCharacterModalStep(1);
        };
        
        const handleImageUpload = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                charImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover">`;
                uploadedImageType = file.type; uploadedImageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        };

        const addActionDnaTag = (tagText, fromCustomInput = true) => {
            if (!tagText) return;
            const tagEl = document.createElement('span');
            tagEl.className = 'action-dna-tag selected bg-cyan-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1 border border-cyan-400';
            tagEl.innerHTML = `${tagText} <span class="cursor-pointer font-bold opacity-70 hover:opacity-100 ml-1">Ã—</span>`;
            tagEl.querySelector('span').onclick = () => tagEl.remove();
            selectedActionDna.appendChild(tagEl);
        };
        
        const handleGenerateActionDNA = async () => {
            actionDnaSuggestions.innerHTML = '<div class="inline-loader w-4 h-4 border-2"></div>';
            const prompt = `5 kata kunci aksi animasi (Indonesia) untuk karakter: ${JSON.stringify(tempDevelopedChar)}. JSON: {action_dna: []}`;
            const schema = { type: "OBJECT", properties: { action_dna: { type: "ARRAY", items: { type: "STRING" } } } };
            try {
                const resultText = await callGeminiAPI(prompt, schema);
                const parsedResult = JSON.parse(resultText);
                actionDnaSuggestions.innerHTML = '';
                parsedResult.action_dna.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = 'btn bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full hover:bg-cyan-900';
                    btn.textContent = tag;
                    btn.onclick = () => { addActionDnaTag(tag, false); btn.remove(); };
                    actionDnaSuggestions.appendChild(btn);
                });
            } catch (error) { actionDnaSuggestions.innerHTML = `<p class="text-xs text-red-400">Gagal.</p>`; }
        };

        const handleCopyText = (e) => {
            const button = e.target.closest('[data-copy-target-id]'); if (!button) return;
            const targetId = button.dataset.copyTargetId; 
            const targetElement = document.getElementById(targetId);
            if (!targetElement) return;
            
            // Modern Clipboard API approach first
            if (navigator.clipboard && window.isSecureContext) {
                 navigator.clipboard.writeText(targetElement.innerText).then(() => {
                     const originalText = button.textContent;
                     button.textContent = 'âœ“';
                     setTimeout(() => button.textContent = originalText, 1500);
                 });
            } else {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = targetElement.innerText;
                textArea.style.position = 'fixed'; textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.textContent;
                    button.textContent = 'âœ“';
                    setTimeout(() => button.textContent = originalText, 1500);
                } catch (err) {}
                document.body.removeChild(textArea);
            }
        };

        const handleExportToJson = () => {
            if (!state.projectTitle && characters.length === 0 && storyboardData.length === 0) return;
            const data = { version: "EduTrends-1.0", state, characters, storyboardData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            saveAs(blob, `edutrends_project_${Date.now()}.json`);
            showNotification("Proyek diekspor.");
        };

        // --- EVENT LISTENERS ---
        const init = () => {
            userApiKey = localStorage.getItem('eduPixarApiKey') || '';
            apiKeyInput.value = userApiKey;
            renderTemplateCharacters();
            updateNarratorLockDisplay();

            // Toggle Password
            document.getElementById('toggle-password').addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                document.getElementById('eye-icon-password').classList.toggle('hidden');
                document.getElementById('eye-slash-icon-password').classList.toggle('hidden');
            });

             document.getElementById('toggle-api-key').addEventListener('click', () => {
                const type = apiKeyInput.type === 'password' ? 'text' : 'password';
                apiKeyInput.type = type;
                document.getElementById('eye-icon-apikey').classList.toggle('hidden');
                document.getElementById('eye-slash-icon-apikey').classList.toggle('hidden');
            });

            // Character Listeners
            charImagePreview.addEventListener('click', () => charImageInput.click());
            charImageInput.addEventListener('change', handleImageUpload);
            openAddCharModalBtn.addEventListener('click', () => { resetCharModal(); characterModal.classList.add('visible'); });
            closeCharModalBtn.addEventListener('click', () => characterModal.classList.remove('visible'));
            closeCharModalIcon.addEventListener('click', () => characterModal.classList.remove('visible'));
            developCharBtn.addEventListener('click', handleDevelopCharacter);
            addCharBtn.addEventListener('click', handleSaveCharacter);
            charNextBtn.addEventListener('click', () => switchCharacterModalStep(3));
            charPrevBtn.addEventListener('click', () => switchCharacterModalStep(currentCharacterModalStep - 1));
            
            // Tab & Main Listeners
            tabNaskah.addEventListener('click', () => switchTab(tabNaskah, naskahView));
            tabStoryboard.addEventListener('click', () => switchTab(tabStoryboard, storyboardView));
            analyzeTextBtn.addEventListener('click', handleAnalyzeText);
            generateScriptBtn.addEventListener('click', handleGenerateScript);
            generateScriptBtnMobile.addEventListener('click', handleGenerateScript);
            generateBtn.addEventListener('click', handleGenerateStoryboard);
            resetProjectBtn.addEventListener('click', () => { showConfirmation("Reset Proyek?", "Semua data akan hilang.").then(p => { if (p) location.reload(); }); });
            
            // Dynamic Listeners
            charListContainer.addEventListener('click', async (e) => {
                const removeBtn = e.target.closest('.remove-char-btn');
                if (removeBtn) {
                     const index = removeBtn.dataset.index;
                     if(await showConfirmation("Hapus Tokoh?", "Tindakan ini tidak bisa dibatalkan.")) {
                         characters.splice(index, 1); renderCharacters();
                     }
                }
                const editBtn = e.target.closest('.edit-char-btn');
                if (editBtn) {
                    const index = editBtn.dataset.index;
                    const char = characters[index];
                    isEditingCharacter = true; editingCharacterIndex = index;
                    tempDevelopedChar = char;
                    charBrandNameInput.value = char.brandName; charModelNameInput.value = char.modelName;
                    charConsistencyKeyInput.value = char.consistency_key; charDesignLanguageInput.value = char.description;
                    selectedActionDna.innerHTML = ''; char.actionDNA.forEach(dna => addActionDnaTag(dna, false));
                    characterModal.classList.add('visible'); switchCharacterModalStep(2);
                }
            });
            
            templateCharList.addEventListener('click', (e) => {
                const btn = e.target.closest('.add-template-char-btn');
                if(btn) {
                    const char = templateCharacters[btn.dataset.index];
                    if(!characters.some(c => c.name === char.name)) {
                        characters.push({...char}); renderCharacters();
                    }
                }
            });

            // Settings
            openSettingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
            saveApiKeyBtn.addEventListener('click', () => { 
                userApiKey = apiKeyInput.value.trim(); 
                localStorage.setItem('eduPixarApiKey', userApiKey); 
                showNotification("API Key disimpan."); 
                settingsModal.classList.remove('visible'); 
            });
            clearApiKeyBtn.addEventListener('click', () => { 
                userApiKey = ''; apiKeyInput.value = ''; localStorage.removeItem('eduPixarApiKey'); 
                showNotification("API Key dihapus."); 
            });
            
            // Inputs
            projectTitleInput.addEventListener('input', (e) => state.projectTitle = e.target.value);
            scenarioInput.addEventListener('input', (e) => { state.scenario = e.target.value; updateUIState(); });
            sceneCountInput.addEventListener('input', (e) => state.sceneCount = parseInt(e.target.value));
            locationSetInput.addEventListener('change', (e) => { 
                state.locationSet = e.target.value; 
                customLocationInput.classList.toggle('hidden', e.target.value !== 'custom_location'); 
            });
            narratorLanguageSetInput.addEventListener('change', (e) => customNarratorLanguageInput.classList.toggle('hidden', e.target.value !== 'custom_language'));
            narratorVoiceSetInput.addEventListener('change', (e) => { state.narratorVoiceSet = e.target.value; updateNarratorLockDisplay(); });
            cameraStyleSetInput.addEventListener('change', (e) => state.cameraStyleSet = e.target.value);
            
            addCustomDnaBtn.addEventListener('click', () => { addActionDnaTag(customActionDnaInput.value.trim()); customActionDnaInput.value = ''; });
            
            // Delegation for generated buttons
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('[data-copy-target-id]')) handleCopyText(e);
                if (e.target.closest('.generate-timecode-btn')) handleGenerateTimecodeScript(e);
                if (e.target.closest('.generate-blueprint-btn')) handleGenerateBlueprint(e);
                if (e.target.closest('.generate-canva-prompt-btn')) handleGenerateCanvaPrompt(e);
            });

            exportProjectBtn.addEventListener('click', handleExportToJson);
            importProjectBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(data.characters && data.state) {
                            characters = data.characters; state = data.state; storyboardData = data.storyboardData || [];
                            projectTitleInput.value = state.projectTitle; scenarioInput.value = state.scenario;
                            sceneCountInput.value = state.sceneCount;
                            renderCharacters(); renderStoryboard(storyboardData); updateUIState();
                            showNotification("Proyek diimpor.");
                        }
                    } catch(err) { showNotification("File rusak."); }
                };
                reader.readAsText(file); e.target.value = '';
            });
        };

        init();
    });
    </script>
</body>
</html>
